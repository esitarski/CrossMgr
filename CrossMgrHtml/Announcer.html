<!DOCTYPE html>
<html>
<!--
	Html Template for Race Animation.
	Generated from CrossMgr software.
	Copyright 2011-2015, Edward Sitarski
	For details, see sites.google.com/site/CrossMgrSoftware
-->
<head>
<meta charset="UTF-8">
<meta http-equiv="cache-control" content="no-cache"/>
<meta name="author" content="Edward Sitarski">
<meta name="copyright" content="Edward Sitarski">
<meta name="generator" content="CrossMgr">  
<meta name="keywords" content="CrossMgr, Cycling, Race, Results">
<link rel="shortcut icon" href="favicon.ico" type="image/x-icon" />
<!-- Meta -->
<title id="idTitle">CrossMgr Announcer</title>
<style type="text/css">
body { font-family: sans-serif; }

#idRaceName {
	font-size: 200%;
	font-weight: bold;
}

#idImgHeader {
	box-shadow: 4px 4px 4px #888888;
}

#detailTitle {
	font-size: 110%;
	font-weight: bold;
}

input[type=range]::-ms-tooltip {
	display: none;
}

.smallfont	{ font-size: 75%; }
.bigfont	{ font-size: 120%; }
.biggerFont	{ font-size: 130%; }

.hidden { display: none; }

table.results {
	font-family:"Trebuchet MS", Arial, Helvetica, sans-serif;
	border-collapse:collapse;
}
table.results td, table.results th {
	font-size:1em;
	padding:3px 7px 2px 7px;
	text-align: right;
}
table.results th {
	font-size:1.1em;
	text-align:right;
	padding-top:5px;
	padding-bottom:4px;
	background-color:#7FE57F;
	color:#000000;
}
table.results tr.odd {
	color:#000000;
	background-color:#EAF2D3;
}
table.results tr:hover {
	color:#000000;
	background-color:#FFFFCC;
}
table.results tr.odd:hover {
	color:#000000;
	background-color:#FFFFCC;
}

table.results tr td.fastest {
	background-image: linear-gradient(
		/* #FF6620, #FFAA20 25%, #FF6620 */
		#00EE00, #00FF00 25%, #00EE00
	);
}
table.results tr td.fastest-lap {
	background-image: linear-gradient(
		/* #FF6A7F, #FF9EAF 25%, #FF6A7F */
		#FF8840, #FFCC40 25%, #FF8840
	);
}
table.results tr td.slowest-lap {
	background-image: linear-gradient(
			#4496F7, #9CC7FB 25%, #4496F7
	);
}

table.results tr td.highlight {
	font-size: 120%;
	font-weight: bold;
}

table.results td {
	border-top:1px solid #98BF21;
}

table.results td.noborder {
	border-top:0px solid #98BF21;
}

table.results td#idNonNumeric, table.results th#idNonNumeric {
	text-align:left;
}

table.results tr td.same-value {
	text-align:center;
}

.flag {
    border: 1px solid #CCC;
}

hr { clear: both; }
hr.invisible { clear: both; visibility: hidden; }

@media print { .noprint { display: none; } }

</style>
<!-- Google Analytics -->

<script type="text/javascript">

// Results and race data.
/* !!! payload begin !!! */
var payload = null;
/* !!! payload end !!! */
var raceName = null;
var organizer = null;
var timestamp = null;
var raceIsRunning = null;
var raceWasRunning = null;
var raceIsUnstarted = null;
var raceIsFinished = null;
var raceStartTime = null;
var isTimeTrial = null;
var winAndOut = null;
var curRaceTime = null;
var data = null;
var catDetails = null;
var iCategoryCur = 1;
var winAndOut = null;
var version = null;
var flags = null;

var checkeredFlag = new Image();
checkeredFlag.src =
"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABcAAAAgCAYAAAD5VeO1AAAEsklEQVRIibWVX0jTaxjHH//029lcVqvM0taNGUHNinGOnkGohJWtQ4KaFEVySlSSUixzTFwZxYnROv2ByisLgwqCIRRhF4EcKsjgeBrDgUqYDhvLJtoyt33OTZPCKLX83L0Xz+f78uV5eUVmiM/na/b7/TUznfsuL1++PM4nbt682V5VVbXkp4jLy8uP6/V6Hj58yPPnz1mwYAEGg2Hs6NGjuT8kttvtxuXLl4dFhNWrV3PhwgXi4uIQEaxW65jP58uflbijo2Phhw8f/m1tbSUpKYlnz54BcP/+fUpLSwmFQkQikbDX6z1ps9lipy222Wyxbre7LdpzU1MTPT09AHg8HrZs2YLb7QagsbGRnJyc/rq6Ov205Lt3725ftWoVT5484erVq4gIS5cuxel0YjQaERF0Oh3Xr1+frGnjxo3B3t5ewzfFTU1NtfPmzUNEKCgowGKxEBMTQ3x8PE6nk4aGBmJjYzGZTLx//57z58+jUqm4ceMGoVAo8ObNm+Kvint7ew0TExOBy5cvk5GRgc/nA+DWrVs4HI5oS7S0tEzWAnDt2jX8fj8Aw8PDrVPEJ06cSHv9+nUPwOjoKBUVFQwMDADgdDoxmUy8evWKjx8/snXrVtavX4/L5eLx48eo1WrS09Pp6OhwtbW1ab4QX7x4UTGZTENr166lq6uL/fv3IyLo9Xru3r2LTqdDRFixYgV2ux0RQUTIysqisrISESE1NTVcU1Pz+5RbHzt27EF04NSpU+zduxcRISUlBY/HQ1VVFSLCkSNHCIVCNDY2snjxYrq6uohEIpw9ezZ8+PDhyilir9d7IBQKcfr0afbs2UMkEgHAbrfz6NGjyV6vXLnCyMjI5PnMmTOMjo4SiUTwer1TxQ0NDcXv3r0bA+ju7ubgwYMEAgEA6urqyMvLY2hoiP7+flauXElmZiZ9fX2cO3cOEWHDhg08ffq0ZYq4trbWoNfrJ4xGIy9evMBgMCAiGAwGmpubiYmJQUTIyMigoqJisueysjJ27tyJiJCZmemvrq7+ZYr8D7O5Mz4+HkVRuHfv3uRATk4Ob9++Zd++fcTFxXHnzh2CwSBlZWVs2rSJkZERJiYmsFqtfovFsm6KWETEYDBo8rdt++fSpUtBgHA4jM1mY3Bw8Iuew+FwdH+pr69nfHycUCg05vF4fv2q+HN27dp1cnBwcGB8fJzs7GwKCwsZHh6mvb0dRVEwm834fD4KCgoQETZv3ozL5TrwXXGU34zG/Jrqam+018LCQnJzcyd7djgcmEwmRISioqKOaYuj6HS6VLPZ3JeSkkJ3dzeBQIDi4mIOHToEQDAYpL6+/j+bzRY/Y7mIyPbt25U/S0tvj42NDQN0dnZisVgIh8MEg0GX2+3WzUr8OTt27Kjt7OwcSEtLQ0QoKSkZd7vdX9+M2bBmzZrsvLw8v6IolJeXW3+aOEpycvISU1bWg/nz56f/dPknYrUajUWjUpnnKkC0anWhWlGOFxUVTf8zngmLtNp1apXKISIL5yZg0aLEBLXasTAh4duf8Y+QoFbXqBWlZM4CEjWafK1GYxWR2b3a7wYkJqapVaq/tVpt0pwELFu2TJOgVv8lIskiIv8DQ4HqhmfkzxMAAAAASUVORK5CYII=";

// Convenience function to get the last element in an array.
Array.prototype.back = function() {
	return this[this.length-1];
};

Array.prototype.binSearch = function( v ) {
	var L = this.length, i = -1, m;
	while( L - i > 1 ) {
		if( this[m = ((L + i)>>1)] < v )
			i = m;
		else
			L = m;
	}
	return L;
}

Array.prototype.swap = function( x, y ) {
	var tmp = this[x];
	this[x] = this[y];
	this[y] = tmp;
}

// Make a string html safe.
String.prototype.escapeHTML = function () {                                        
	var r =                                                               
		this.replace(/&/g,'&amp;').
			replace(/>/g,'&gt;').
			replace(/</g,'&lt;').
			replace(/"/g,'&quot;').
			replace(/'/g,'&rsquo;');
	return r;
};

// Make a string id safe.
String.prototype.escapeID = function() {
	return this.replace(/[&<>"'(){}\[\]!@#$%^* ]/g,'_');
};

// Encode/decode utf8
function encode_utf8( s ) {
  return unescape( encodeURIComponent(s) );
}

function decode_utf8( s ) {
  return decodeURIComponent( escape(s) );
}

function isEmptyObject( obj ) {
    for( let name in obj ) {
        return false;
    }
    return true;
}

// Set the name of the hidden property and the change event for visibility
var hidden, visibilityChange; 
if (typeof document.hidden !== "undefined") { // Opera 12.10 and Firefox 18 and later support 
  hidden = "hidden";
  visibilityChange = "visibilitychange";
} else if (typeof document.mozHidden !== "undefined") {
  hidden = "mozHidden";
  visibilityChange = "mozvisibilitychange";
} else if (typeof document.msHidden !== "undefined") {
  hidden = "msHidden";
  visibilityChange = "msvisibilitychange";
} else if (typeof document.webkitHidden !== "undefined") {
  hidden = "webkitHidden";
  visibilityChange = "webkitvisibilitychange";
}

var flagImages = null;
function GetFlagImage( uci ) {
	if( !flagImages ) {
		if( !flags )
			return null;
		flagImages = {};
		for( var cc in flags ) {
			img = new Image();
			img.src = flags[cc];
			img.className = 'flag';
			flagImages[cc] = img;
		}
	}
	return flagImages[uci.substring(0, 3)];
}
 
function ordinal( value ) {
	value = parseInt( value );
	
	if( langCur == 1 ) return value == 1 ? (value+'er') : (value+'e');
	if( langCur == 2 ) return value + '.&#xb0;';
	
	if( Math.floor((value % 100)/10) != 1 )
		return value + ['th','st','nd','rd','th','th','th','th','th','th'][value%10];
	return value + "th";
}

function FormatTime( t ) {
	var tStr = '';
	if( t < 0 )
	{
		tStr = '-';
		t = -t;
	}
	var secs = ~~t;
	var h = ~~(secs / (60*60));
	var m = (~~(secs / 60) % 60);
	var s = ~~(secs % 60);
	if( h > 0 )
		tStr += h + (m < 10 ? ':0' : ':') + m + (s < 10 ? ':0' : ':') + s;
	else
		tStr += m + (s < 10 ? ':0' : ':') + s;
	return tStr;
}

function FormatTimeGap( t )
{
	var tStr = '';
	if( t < 0 ) {
		tStr = '-';
		t = -t;
	}
	var secs = ~~t;
	var h = ~~(secs / (60*60));
	var m = (~~(secs / 60) % 60);
	var s = ~~(secs % 60);
	if( h > 0 )
		tStr += h + (m < 10 ? 'h0' : 'h') + m + (s < 10 ? "'0" : "'") + s;
	else
		tStr += m + (s < 10 ? "'0" : "'") + s;
	tStr += '"';
	return tStr;
}

function getRiderName( num ) {
	var d = data[num + ''];
	if( !d )
		return '';
	var s = (d['FirstName'] || '') + ' ' + (d['LastName'] || '');
	return s.replace(/^\s\s*/, '').replace(/\s\s*$/, '');
}

function getRiderTeam( num ) {
	var team = '';
	var d = data[num];
	if( d && d['Team'] )
		team = d['Team'];
	return team;
}

// ---------------------------------------------------------------------
function SetData( aData, tCur )
{
	if( !catDetails )
		catDetails = [];
	
	// Data is rider information indexed by number.  Info includes lap times and lastTime times.
	// Race times should include the start offset.
	// Example:
	//    data = { 101: { raceTimes: [xx, yy, zz], lastTime: None, category: 'All' }, 102 { raceTimes: [aa, bb], lastTime: cc, category: 'Cat'} }
	data = (aData || null);
	if( tCur != undefined )
		t = tCur;
}

// ---------------------------------------------------------------------

function createChild( parent, tag ) {
	var child = document.createElement(tag);
	parent.appendChild( child );
	return child;
}

function createTextChild( parent, s ) {
	var child = document.createTextNode(s);
	parent.appendChild( child );
	return child;
}

//----------------------------------------------------------------------

function applyRAM( dest, ram ) {
	var src, i, k;
	src = ram.a;
	for( k in src )
		dest[k] = src[k];
	src = ram.m;
	for( k in src )
		dest[k] = src[k];
	src = ram.r;
	for( i = src.length-1; i >= 0; --i )
		delete dest[src[i]];
}

function PostMessageRefresh() {
	SetData( data, undefined );
	RefreshResultsTable();
}

function SyncMsgPayload( msg ) {
	for( f in msg.reference )
		window[f] = msg.reference[f];
	tNow = strToMillis( tNow );
	raceStartTime = (new Date).getTime() - curRaceTime*1000;
}

function getRaceTime() {
	return raceStartTime ? ((new Date).getTime() - raceStartTime) / 1000.0 : null;
}

function isCurrentResults() {
	return true;
}

var versionCount = 0;
function ProcessRAM( msg ) {
	if( !isCurrentResults() ) {
		if( raceName && msg.reference.raceName != raceName )
			return true;
	}
	if( msg.cmd != 'ram' || msg.reference.versionCount != versionCount + 1 )
		return false;
		
	if( !data )
		data = {};
	applyRAM( data, msg.infoRAM );
	
	var c, k, f;
	var catDetailsCur = {};
	if( catDetails )
		for( c = 0; c < catDetails.length; ++c )
			catDetailsCur[catDetails[c].name] = catDetails[c];
	
	applyRAM( catDetailsCur, msg.categoryRAM );
	
	catDetails = [];
	for( k in catDetailsCur )
		catDetails.push( catDetailsCur[k] );
	catDetails.sort( function(a, b) {return a.iSort - b.iSort;} );

	SyncMsgPayload( msg );
	return true;
}
var baselinePending = false;
function ProcessBaseline( msg ) {
	if( !isCurrentResults() ) {
		if( msg.reference.raceName != raceName )
			return true;
	}
	if( msg.cmd != 'baseline' )
		return false;
	
	data = msg.info;
	
	let c, k, f;
	catDetails = [];
	for( k in msg.categoryDetails )
		catDetails.push( msg.categoryDetails[k] );
	catDetails.sort( function(a, b) {return a.iSort - b.iSort;} );
	
	SyncMsgPayload( msg );
	
	baselinePending = false;	
	return true;
}
var websocket = null;
var timeoutID = null;
function RetryResetWebSocket() {
	if( timeoutID === null )
		timeoutID = setTimeout( ResetWebSocket, 5000 );
}
function ResetWebSocket() {
	if( window.location.port != '8765' )	// Set up a websocket only if we are connected to CrossMgr.
		return;
		
	if( timeoutID !== null ) {
		clearTimeout( timeoutID );
		timeoutID = null;
	}

	if ("WebSocket" in window) {
		if( websocket && websocket.readyState != websocket.CLOSED ) {
			websocket.close();
			websocket = null;
		}

		var wsurl = 'ws://' + window.location.hostname + ':' + (parseInt(window.location.port) + 1) + '/';
		//var wsurl = 'ws://' + 'localhost' + ':' + (parseInt(window.location.port) + 1) + '/';
		console.log( 'wsurl="' + wsurl + '"' );
		websocket = new window.WebSocket( wsurl );

		websocket.onmessage = function( evt ) {
			var isCurResults = isCurrentResults();
			var localRaceName = isCurResults ? 'CurrentResults' : raceName;
			var msg = JSON.parse( evt.data );
			if( !msg.reference ) {
				console.log( evt.data );
				return;
			}
			if( msg.reference.raceName == raceName || isCurResults ) {
				if( msg.cmd == 'ram' ) {
					if( ProcessRAM(msg) )
						PostMessageRefresh();
					else {
						if( !baselinePending ) {
							websocket.send( JSON.stringify({'cmd':'send_baseline', 'raceName':localRaceName}) );
							baselinePending = true;
						}
					}
				}
				else if( msg.cmd == 'baseline' ) {
					if( ProcessBaseline(msg) )
						PostMessageRefresh();
				}
			}
			else if( msg.cmd == 'reload_previous' && isPreviousResults() ) {
				RefreshPayload();
			}
		};
		
		websocket.onerror = function(e) {
			console.log('WebSocket: Error.  Scheduling reconnect in 5 seconds...');
			RetryResetWebSocket();
		};
		
		websocket.onopen = function(e) {
			websocket.send( JSON.stringify({'cmd':'send_baseline', 'raceName':'CurrentResults'}) );
		}
		
		websocket.onclose = function(e) {
			console.log('WebSocket: Closed.  Scheduling reconnect in 5 seconds...');
			RetryResetWebSocket();
		};
	}
}
function CloseWebSocket() {
	if( websocket )
		websocket.close();
	websocket = null;
}

var expected = [], recorded = [], tExpected = {}, bibRecorded = {}, isRecorded = [];
function getExpectedRecorded() {
	expected = [];
	recorded = [];
	tExpected = {};
	bibRecorded = {};
	
	if( !data )
		return;
	
	let tCur = getRaceTime();
	if( !tCur )
		return;
	
	if( isTimeTrial ) {
		let interpValue = true;
		for( num in data ) {
			let rr = data[num];
			if( rr && (rr.status == 'NP' || rr.status == 'Finisher') && (rr.lapTimes && rr.lapTimes.length == 0) ) {
				if( rr.startTime != null ) {
					let e = {'num':num, 'lap':0, 't':rr.startTime, 'interp':interpValue};
					if( rr.startTime >= tCur && e.interp ) {
						expected.push( e );
						tExpected[num] = rr.startTime;
					}
					else {
						recorded.push( e );
						bibRecorded[num] = e;
					}
				}
			}
		}
	}
	
	let lapMin = 1;
	for( num in data ) {
		let rr = data[num];
		if( !rr || rr.status != 'Finisher' || !rr.raceTimes || rr.raceTimes.length < 2 )
			continue;
		// Correct for the TT start time.
		let offset = isTimeTrial ? (rr.startTime||0.0) : 0.0;
		
		let i = rr.raceTimes.binSearch( tCur - offset );
		
		// Get the next expected lap.  Consider that the rider could have been missed from the last lap.
		let lap, t;
		try {
			lap = i;
			if( lap > 1 && rr.interp[lap-1] )
				lap -= 1;
			// Add the TT start time back.
			t = rr.interp[lap] ? rr.raceTimes[lap] + offset : null;
		}
		catch( err ) {
			console.log( err );
			t = null;
		}
		if( t != null && lap >= lapMin ) {
			expected.push( {'num':num, 'lap':lap, 't':t, 'interp':rr.interp[lap]} );
			tExpected[num] = t;
		}
		
		// Get the last recorded lap.
		try {
			lap = i - 1;
			while( lap > 0 && rr.interp[lap] )
				--lap;
			t = (lap == 0 || !rr.interp[lap]) ? rr.raceTimes[lap] + offset : null;
		}
		catch( err ) {
			t = null;
		}
		if( t != null && lap >= lapMin ) {
			let e = {'num':num, 'lap':lap, 't':t, 'interp':rr.interp[lap]};
			recorded.push( e );
			bibRecorded[num] = e;
		}
	}
	
	expected.sort( function(x, y) { return x.t - y.t; } );
	recorded.sort( function(x, y) { return x.t - y.t; } );
}

function GetContrastTextColour( backgroundColour ) {
	let v = parseInt(backgroundColour.slice(1),16);
	let r = v>>16, g = (v>>8) & 0xFF, b = v & 0xFF;
	let yiq = ((r*299)+(g*587)+(b*114))/1000.0
	return yiq >= 128.0 ? '#000000' : '#FFFFFF';
}

var cols = ['Pos', 'Name', 'Team', 'Bib', 'Gap', 'Group', 'ETA'];
var iCol = {};
for( var i = 0; i < cols.length; ++i )
	iCol[cols[i]] = i;
iCol['Time'] = iCol['Group'];

var groupColours = '#66c2a5,#fc8d62,#8da0cb,#e78ac3,#a6d854,#ffd92f,#e5c494,#b3b3b3'.split(',');
var groupTextColours = [];
for( var i = 0; i < groupColours.length; ++i )
	groupTextColours.push( GetContrastTextColour(groupColours[i]) );

var alertETA = 15;
var greenScale = '#6AA661,#6EAC65,#72B268,#76B86C,#7BBE70,#7FC574,#83CB77,#87D17B,#8CD87F,#90DE83,#95E587,#99EB8B,#9EF28F,#A2F893,#A7FF96'.split(',');
greenScale.reverse();
var greenColourMap = {};
(function () {
	let i;
	greenColourMap = {};
	for( i = 0; i < alertETA; ++i ) {
		greenColourMap[i] = greenScale[i];
		greenColourMap[-i] = greenScale[0];
		greenColourMap[-alertETA-i] = greenScale[i];
	}
})();

var recordedColour = RGB2Color(255, 255, 255);
var unrecordedColour = RGB2Color(220, 220, 220);
var recordedChar = "\u2192";
var isRecorded = [];

function getScaleColour( eta ) {
	let colour = greenColourMap[Math.floor(eta)];
	if( colour )
		return colour;
	return eta < 0.0 ? greenScale[greenScale.length-1] : null
}

function setCategory( i ) {
	i = i || iCategoryCur;
	if( !catDetails || catDetails.length == 0 || i >= catDetails.length )
		i = 1;
	iCategoryCur = i;
	for( let j = 0; j < categoryButtons.length; ++j ) {
		categoryButtons[j].style.borderWidth = ((j == i-1 ) ? 4 : 1) + 'px';
		categoryButtons[j].style.border = (j == i-1) ? 'dotted orange' : 'black';
	}
}

var categoryButtons = [];
var categoryNames = [];
function RefreshCategories() {
	var rebuildButtons = ( catDetails.length-1 != categoryNames.length );
	if( !rebuildButtons ) {
		for( let i = 0; i < categoryNames.length; ++i ) {
			if( categoryNames[i] != catDetails[i+1].name ) {
				rebuildButtons = true;
				break;
			}
		}
	}
	
	if( rebuildButtons ) {
		categoryButtons = [];
		categoryNames = [];
		categoriesDiv.innerHTML = '';
		if( catDetails.length > 2 ) {
			for( let i = 1; i < catDetails.length; ++i ) {
				let b = document.createElement('BUTTON');
				b.innerHTML = catDetails[i].name.escapeHTML();
				b.style.margin = '8px';
				b.style.fontSize = '120%';
				b.onclick = (function( iCategory ) { return function() {setCategory(iCategory); RefreshResultsTable();} })( i );
				categoryButtons.push( b );
				categoryNames.push( catDetails[i].name );
				categoriesDiv.appendChild( b );
			}
		}
	}
	
	let tRace = getRaceTime();
	if( tRace && !isTimeTrial ) {
		for( let i = 0; i < categoryButtons.length; ++i ) {
			let v = '', colour = null;
			if( catDetails[i+1].pos.length > 0 && tExpected[catDetails[i+1].pos[0]] ) {
				let eta = tExpected[catDetails[i+1].pos[0]] - tRace;
				v = FormatTime( eta );
				colour = getScaleColour( eta );
			}
			categoryButtons[i].innerHTML = v + (v!='' ? ' ' : '') + catDetails[i+1].name.escapeHTML();
			categoryButtons[i].style.background = (colour || unrecordedColour);
		}
	}
}

function RefreshETA() {
	if( document.hidden )
		return;
	if( !catDetails || catDetails.length == 0 || iCategoryCur === null )
	{
		categoriesDiv.innerHTML = '';
		let tNow = new Date();
		let tStr = tNow.getHours() + ':' + ('0'+tNow.getMinutes()).slice(-2) + ':' + ('0'+tNow.getSeconds()).slice(-2);
		resultsDiv.innerHTML = '<p style="font-size:700%;">' + tStr + '</p>';
		return;
	}

	setCategory();

	let categoryCur = catDetails[iCategoryCur];
	if( !categoryCur )
		return;
	
	if( !isTimeTrial ) {
		let resultsBody = document.getElementById('idResultsBody');
		let iETA = iCol['ETA'];
		
		let tRace = getRaceTime();
		for( let r = 0, tr = resultsBody.firstChild; r < categoryCur.pos.length && tr; ++r, tr = tr.nextSibling ) {
			let num = categoryCur.pos[r];
			let rr = data[num];
			
			let v = '', colour = null;
			if( tExpected[num] ) {
				let eta = tExpected[num] - tRace;
				v = FormatTime( eta );
				colour = getScaleColour( eta );
			}
			let td = tr.childNodes[iETA];
			td.innerHTML = v;
			td.style.backgroundColor = colour ? colour : (isRecorded[r] ? recordedColour : unrecordedColour);
		}
	}
	
	RefreshCategories();
}

function strToMillis( s ) {
	if( s == null )
		return null;
	s = s.replace(/[^0-9]/g,' ');
	let v = s.split(' ');
	return (new Date(
		parseInt(v[0],10), parseInt(v[1],10)-1, parseInt(v[2],10),
		parseInt(v[3],10), parseInt(v[4],10), parseInt(v[5],10), parseInt(v[6],10)
	)).getTime();
}

function RefreshResultsTable() {
	setCategory();

	resultsDiv.innerHTML = '';
	titleDiv.innerHTML = '';
	isRecorded = [];

	if( !data || !catDetails || !catDetails.length )
		return;
	let categoryCur = catDetails[iCategoryCur];
	
	// Show results for this category.
	getExpectedRecorded();
	
	let tRace = getRaceTime();

	// Update the category information.
	let leader, leaderLap, tLeader;
	try {
		leader = data[categoryCur.pos[0]];
		leaderLap = Math.min( leader.raceTimes.binSearch(tRace), leader.raceTimes.length-1 );
		if( leader.interp[leaderLap] )
			--leaderLap;
		tLeader = leader.raceTimes[leaderLap];
	}
	catch( err ) {
		leader = leaderLap = tLeader = null;
	}
	
	let v = categoryCur.name;
	let lapsToGo;
	try {
		lapsToGo = leader.raceTimes.length - 1 - (leaderLap || 0);
	}
	catch( err ) {
		lapsToGo = null;
	}
	if( lapsToGo != null ) {
		if( lapsToGo <= 0 ) {
			lapsToGo = 0;
			v += ': ' + 'Finish';
		}
		else
			v += ': ' + lapsToGo + ' ' + (lapsToGo == 1 ? 'lap to go' : 'laps to go');
	}
	if( leader && leader.speed )
		v += ', ' + leader.speed;
		
	titleDiv.innerHTML = v;
	if( lapsToGo == 0 )
		titleDiv.appendChild( checkeredFlag );
	
	// Update the results information.	
	let table = document.createElement('TABLE');
	table.className = 'results';
	let thead = createChild( table, 'THEAD' );
	let tr = createChild( thead, 'TR' );
	let td;
	for( let i = 0; i < cols.length; ++i ) {
		let colName = cols[i];
		if( isTimeTrial && colName == 'ETA' )
			continue;
		if( isTimeTrial && colName == 'Group' )
			colName = 'Time';
		createTextChild( td = createChild(tr, 'TH'), colName );
		if( colName == 'Name' || colName == 'Team' )
			td.style.textAlign = "left";
	}
	
	let tbody = createChild( table, 'TBODY' );
	tbody.id = 'idResultsBody';
	
	let iGroup = -1;
	let rowGroup = [], groupCount = {};
	let tdGroup = [];
	let numPrev = null;
	for( let r = 0; r < categoryCur.pos.length; ++r ) {
		let num = categoryCur.pos[r];
		let rr = data[num];
		let isComplete = (rr.raceTimes && rr.raceTimes.back() && !rr.interp.back());
		if( isTimeTrial ) {
			if( !(rr.status == 'Finisher' || rr.status == 'NP') )
				break;
		}
		else {	// !isTimeTrial
			if( !(rr.status == 'Finisher') )
				break;
		}
		tr = createChild( tbody, 'TR' );
		
		let pos, bg;
		let e = bibRecorded[num];
		if( isTimeTrial ) {
			if( isComplete ) {
				pos = r + 1;
				bg = recordedColour;
			}
			else {
				pos = 'NP';
				bg = unrecordedColour;
			}
		}
		else {
			if( !raceIsRunning || (leaderLap == 1 || (e && tLeader !== null && e.t >= tLeader)) ) {
				pos = r + 1;
				isRecorded.push( true );
				bg = recordedColour;
			}
			else {
				pos = (r+1) + recordedChar;
				isRecorded.push( false );
				bg = unrecordedColour;
			}
		}
			
		createTextChild( td = createChild(tr, 'TD'), pos );										// Pos
		td.style.backgroundColor = bg;
		
		createTextChild( td = createChild(tr, 'TD'), getRiderName(num) );						// Name
		td.style.backgroundColor = bg;
		td.style.textAlign = "left";
		
		createTextChild( td = createChild(tr, 'TD'), getRiderTeam(num) );						// Team
		td.style.backgroundColor = bg;
		td.style.textAlign = "left";
		
		createTextChild( td = createChild(tr, 'TD'), num );										// Bib
		td.style.backgroundColor = bg;
		
		let gapValue = categoryCur.gapValue[r];
		if( r == 0 )
			gap = '';
		else if ( isTimeTrial ) {
			gap = (isComplete ? FormatTimeGap( gapValue ) : '');
		}
		else if ( gapValue > 0 )
			gap = FormatTimeGap( gapValue );
		else
			gap = gapValue + '';
		createTextChild( td = createChild(tr, 'TD'), gap );										// Gap
		td.style.backgroundColor = bg;
		
		if( isTimeTrial ) {
			let finishTime = '';
			if( isComplete )
				finishTime = FormatTime(rr.raceTimes.back());
			else if( tRace < rr.startTime )
				finishTime = '[' + FormatTime(rr.startTime) + ']';
			createTextChild( td = createChild(tr, 'TD'), finishTime );							// Finish Time
			td.style.backgroundColor = bg;
		}
		else {
			createTextChild( td = createChild(tr, 'TD'), '' );									// Group
			td.style.backgroundColor = bg;
			tdGroup.push( td );
		}
		
		if( !isTimeTrial ) {
			createTextChild( td = createChild(tr, 'TD'), '' );									// ETA
			td.style.backgroundColor = bg;
			if( !(tExpected[num] && tExpected[numPrev] && Math.abs(tExpected[num] - tExpected[numPrev]) < 1.0) )
				++iGroup;
			rowGroup.push( iGroup );
			groupCount[iGroup] = (groupCount[iGroup] || 0) + 1;
		}

		numPrev = num;
	}
	
	if( !isTimeTrial ) {
		let iGroupColour = 0;
		let r = 0;
		while( r < rowGroup.length ) {
			if( groupCount[rowGroup[r]] > 1 ) {
				tdGroup[r].innerHTML = (iGroupColour + 1) + ' [' + groupCount[rowGroup[r]] + ']';

				let iGroupCur = rowGroup[r];
				let colour = groupColours[iGroupColour % groupColours.length];
				let colourText = groupTextColours[iGroupColour % groupColours.length];
				while( rowGroup[r] == iGroupCur && r < rowGroup.length ) {
					tdGroup[r].style.background = colour;
					tdGroup[r].style.color = colourText;
					++r;
				}
				++iGroupColour;
			}
			else
				++r;
		}
	}
	
	resultsDiv.appendChild( table );
	RefreshETA();
}

function byte2Hex(n) {
	var nybHexString = "0123456789ABCDEF";
	return String(nybHexString.substr((n >> 4) & 0x0F,1)) + nybHexString.substr(n & 0x0F,1);
}

function RGB2Color(r,g,b) {
	return '#' + byte2Hex(r) + byte2Hex(g) + byte2Hex(b);
}

function lighterColour( k, factor ) {
	if( !factor )
		factor = 0.6;
	let s = '#';
	for( let i = 0; i < 3; ++i ) {
		let c = parseInt(k.substring(1 + i*2, 1 + i*2 + 2), 16);
		c += (255 - c) * factor;
		c = ~~c;
		s += (c < 16 ? '0' : '') + c.toString(16);
	}
	return s;
}

// ---------------------------------------------------------------------
function onLoad() {
	categoriesDiv = document.getElementById('idCategoriesDiv');
	titleDiv = document.getElementById('idTitleDiv');
	resultsDiv = document.getElementById('idResultsDiv');
	var s = '<p style="padding-top:10px; font-size:40px; color:#AAAAAA;"><img src="/favicon.ico" style="width:32px; height:32px; padding-left:30px; padding-right:30px" />Powered by CrossMgr</p>';
	document.getElementById('idBrandingDiv').innerHTML = s;
	ResetWebSocket();
	setInterval( RefreshETA, 1000 );
}

</script>

</head>
<body onload="onLoad()">
<link id="favicon" href="/favicon.ico" rel="shortcut icon" type="image/x-icon"  />
CrossMgr Live Results<br/>
<div id="idCategoriesDiv"></div>
<div id="idTitleDiv" style="font-size: 150%;"></div>
<div id="idResultsDiv"></div>
<div id="idBrandingDiv"></div>
</body>
</html>
