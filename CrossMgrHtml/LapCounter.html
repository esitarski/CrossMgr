<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title>LapCounter</title>
		<link rel="icon" type="image/png" href="data:image/png;base64,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" />
		<style>
			* { margin:0; padding:0 }
			html, body { width:100%; height:100%; }
			canvas { display:block; }
		</style>
<script>

function hex( n ) {
	return ('0'+Number(n).toString(16)).slice(-2);
}
function color( r, g, b ) {
	return '#' + hex(r) + hex(g) + hex(b);
}

function CleanLCLabel( lcLabelIn ) {
	lcLabelIn = lcLabelIn.toUpperCase();
	var lcLabel = '';
	for( var i = 0; i < lcLabelIn.length; ++i ) {
		var c = lcLabelIn.charAt(i);
		// Accept letters and numbers for lap display.
		if( '1' <= c && c <= '9' )
			c = String.fromCharCode('A'.charCodeAt(0) + c.charCodeAt(0) - '1'.charCodeAt(0));
		if( c == '-' ) {
			if( lcLabel && lcLabel.charAt([lcLabel.length-1]) != '-' )
				lcLabel += '-';
		}
		else if ( 'A' <= c && c <= cMaxLabels )
			lcLabel += c;
	}
	return lcLabel;
}

function GetLCLabel() {
	var lcLabel = '';
	var matches = /^\/LapCounter([1-9A-Z-]+)\.html$/.exec( window.location.pathname );
	if( matches != null && matches.length == 2 )
		lcLabel = matches[1];
	return CleanLCLabel( lcLabel );
}

function formatTime( secs ) {
	secs = Math.floor( secs );
	var s = secs % 60;
	var m = Math.floor(secs / 60) % 60;
	var h = Math.floor(secs / (60*60));
	return (h ? (h + ':') : '') +  ('0' + m + ':').slice(-3) + ('0' + s).slice(-2);
}

function formatTimeNoLeadingZero( secs ) {
	var t = formatTime( secs );
	if( t && t.charAt(0) == '0' )
		t = t.substring( 1 )
	return t;
}
	

function strToMillis( s ) {
	if( s == null )
		return null;
	s = s.replace(/[^0-9]/g,' ');
	var v = s.split(' ');
	return (new Date(
		parseInt(v[0],10), parseInt(v[1],10)-1, parseInt(v[2],10),
		parseInt(v[3],10), parseInt(v[4],10), parseInt(v[5],10), parseInt(v[6],10)
	)).getTime();
}

var MaxLabels = 6;
var cMaxLabels = String.fromCharCode('A'.charCodeAt(0) + MaxLabels - 1);

function LapCounter( aCanvas ) {
	this.canvas = aCanvas;
	this.flashOn = false;
	this.nTimer = 0;
	this.labels = [['999',false,null]];
	this.foregrounds = ['#FFFFFF','#FFFFFF','#FFFFFF','#FFFFFF','#FFFFFF','#FFFFFF'];
	this.backgrounds = [color(16,16,16), color(34,139,34), color(235,155,0), color(147,112,219), color(0,0,139), color(139,0,0)];
	this.lapElapsedClock = true;
	this.tRaceStart = null;

	this.tessellate = function ( numLabels ) {
		var width = this.canvas.width, height = this.canvas.height;
		if( numLabels == 1 ) {
			return [[0, 0, width, height]];
		}
		else if( numLabels == 2 ) {
			w = Math.floor(width / 2);
			return [[0, 0, w, height], [w, 0, w, height]];
		}
		else if( numLabels <= 4 ) {
			w = Math.floor(width / 2);
			h = Math.floor(height / 2);
			return [
				[0, 0, w, h], [w, 0, w, h],
				[0, h, w, h], [w, h, w, h],
			];
		}
		else {
			w = Math.floor(width / 3);
			h = Math.floor(height / 2);
			return [
				[0, 0, w, h], [w, 0, w, h], [2*w, 0, w, h],
				[0, h, w, h], [w, h, w, h], [2*w, h, w, h],
			];
		}
	}
	
	this.getRectangles = function( lcLabel ) {
		var colsPerRow = [0];
		var lcs = [];
		for( var i = 0; i < lcLabel.length; ++i ) {
			var c = lcLabel.charAt(i);
			if( '1' <= c && c <= '9' )
				c = String.fromCharCode( c.charCodeAt(0) - '1'.charCodeAt(0) + 'A'.charCodeAt(0) );
			if( c == '-' )
				colsPerRow.push( 0 );
			else if( 'A' <= c && c <= cMaxLabels) {
				++colsPerRow[colsPerRow.length-1];
				lcs.push( c.charCodeAt(0) - 'A'.charCodeAt(0) );
			}
		}
		
		var lcPositions = new Array( MaxLabels );
		if( colsPerRow.length == 1 && colsPerRow[0] == 0 )
			return lcPositions;
		
		var width = this.canvas.width, height = this.canvas.height;
		var h = height / colsPerRow.length;
		var iLC = 0;
		for( var row = 0; row < colsPerRow.length; ++row ) {
			var w = width / colsPerRow[row];
			for( var col = 0; col < colsPerRow[row]; ++col )
				lcPositions[lcs[iLC++]] = [Math.floor(col*w), Math.floor(row*h), Math.floor(w), Math.floor(h)];
		}
		return lcPositions;
	}
	
	this.onResize = function() {
		this.canvas.width = window.innerWidth;
		this.canvas.height = window.innerHeight;
		this.draw();
	}

	this.onTimer = function() {
		this.flashOn = !this.flashOn;
		this.draw();
	}
	
	this.needsTimer = function() {
		for( var i = 0; i < this.labels.length; ++i ) {
			if( this.labels[i][1] ) {
				return true;
			}
		}
		if( this.lapElapsedClock ) {
			for( var i = 0; i < this.labels.length; ++i ) {
				if( this.labels[i][2] != null ) {
					return true;
				}
			}
		}
		return false;
	}

	this.setLabels = function( labels ) {
		labels = labels || [['999', false, null]];
		
		// labels is of the format [[label1, flash, tLapStart], [label2, flash, tLapStart], ...]
		this.labels = labels.slice(0, MaxLabels);
		if( this.needsTimer() ) {
			if( !this.nTimer ) {
				this.nTimer = setInterval( this.onTimer.bind(this), 333 );
				this.flashOn = true;
			}
		}
		else {
			if( this.nTimer ) {
				clearInterval( this.nTimer );
				this.nTimer = 0;
			}
		}
		this.draw();
	}

	this.onRefresh = function( msg ) {
		this.tRaceStart = (new Date).getTime() - msg.curRaceTime * 1000.0;
		this.foregrounds = msg.foregrounds;
		this.backgrounds = msg.backgrounds;
		this.lapElapsedClock = msg.lapElapsedClock;
		this.setLabels( msg.labels );
	}
	
	this.draw = function() {
		var dc = this.canvas.getContext('2d');
		var width = this.canvas.width, height = this.canvas.height;
		
		// Get the labels to draw from the url path.
		var lcLabel = GetLCLabel();

		// Check if we are drawing anything.
		var drawSomething = (this.labels.length > 0);
		if( lcLabel ) {
			drawSomething = false;
			for( var i = 0; !drawSomething && i < this.labels.length; ++i )
				drawSomething = (lcLabel.indexOf(String.fromCharCode('A'.charCodeAt(0) + i)) >= 0);
		}
		if( !drawSomething ) {
			dc.fillStyle = '#D3D3D3';
			dc.fillRect( 0, 0, width, height );
			return;
		}
		
		dc.fillStyle = '#000000';
		dc.fillRect( 0, 0, width, height );
		
		function getFontSizeToFit( dc, text, w, h ) {
			w = Math.floor( w * 0.95 );
			h = Math.floor( h * 0.95 );
			var fontSize = h * 1.15;
			dc.font = 'bold ' + fontSize + "px Arial";
			var wText = dc.measureText( text ).width;
			if( wText > w ) {
				fontSize *= w / wText;
				dc.font = 'bold ' + fontSize + "px Arial";
			}
			return fontSize;
		}
		
		function drawText( dc, label, colour, x, y, w, h ) {
			var fontSize = getFontSizeToFit( dc, label, w, h );
			var xText = x + w/2, yText = y + h / 2;
			dc.textAlign = 'center';
			dc.textBaseline = 'middle';
			dc.fillStyle = colour;
			dc.fillText( label, xText, yText );
		}
		
		function drawLapText( dc, label, colour, x, y, w, h ) {
			var fontSize = getFontSizeToFit( dc, label, w, h );
			var xText = x + w/2, yText = y + h / 2;
			dc.textAlign = 'center';
			dc.textBaseline = 'middle';
			if( colour != '#000000' ) {
				dc.fillStyle = '#000000';
				var shadowOffset = fontSize/52;
				dc.fillText( label, xText + shadowOffset, yText + shadowOffset );
			}
			dc.fillStyle = colour;
			dc.fillText( label, xText, yText );
		}
		
		// Get the position of each label on the screen.
		var rects = (lcLabel ? this.getRectangles(lcLabel) : this.tessellate(this.labels.length));
		
		var footerMult = 0.18;
		var lineBorderWidth = 4;
		for(var i = 0; i < this.labels.length; ++i ) {
			var rect = rects[i];
			if( rect == undefined )
				continue;
			var hCC, yCC;
			var entry = this.labels[i];
			var label = entry[0] + '', flash = entry[1], tLapStart = entry[2];
			var x = rect[0], y = rect[1], w = rect[2], h = rect[3];
			
			dc.fillStyle = this.backgrounds[i];
			dc.fillRect( x, y, w, h );
			dc.lineWidth = lineBorderWidth;
			dc.strokeStyle = '#000000';
			dc.strokeRect( x, y, w, h );
			
			if( this.labels.length > 1 ) {
				hCC = h * footerMult;
				yCC = y + h - hCC;
				drawText( dc, String.fromCharCode('A'.charCodeAt(0) + i), this.foregrounds[i], x, yCC, hCC, hCC );
			}
			
			if( label == '1' ) {
				// Draw a bell in the last lap.
				hCC = h * footerMult;
				yCC = y + h - hCC;
				drawText( dc, '\uD83D\uDD14', this.foregrounds[i], x + w - hCC, yCC, hCC, hCC );
			}
			
			if( this.lapElapsedClock ) {
				hCC = h * footerMult;
				yCC = y + h - hCC;
				h -= hCC;
				if( tLapStart != null && this.tRaceStart ) {
					var tLap = this.tRaceStart + tLapStart*1000.0;
					var secs = ((new Date).getTime() - tLap)/1000.0;
					drawText( dc, formatTimeNoLeadingZero(secs), this.foregrounds[i], x, yCC, w, hCC );
				}
			}
			if( !flash || this.flashOn )
				drawLapText( dc, label, this.foregrounds[i], x, y, w, h );
		}
	}
	this.setLabels( this.labels );
}

var websocket = null;
var timeoutID = null;
function RetryResetWebSocket() {
	if( timeoutID === null )
		timeoutID = setTimeout( ResetWebSocket, 5000 );
}
function ResetWebSocket() {
	if( timeoutID !== null ) {
		clearTimeout( timeoutID );
		timeoutID = null;
	}

	if ("WebSocket" in window) {
		if( websocket && websocket.readyState != websocket.CLOSED ) {
			websocket.close();
			websocket = null;
		}

		var wsurl = 'ws://' + window.location.hostname + ':' + (parseInt(window.location.port) + 2) + '/';
		//var wsurl = 'ws://' + 'localhost' + ':' + (parseInt(window.location.port) + 2) + '/';
		//console.log( 'wsurl="' + wsurl + '"' );
		websocket = new window.WebSocket( wsurl );

		websocket.onmessage = function( evt ) {
			var msg = JSON.parse( evt.data );
			if( msg.cmd == 'refresh' ) {
				lapCounter.onRefresh( msg );
			}
		};
		
		websocket.onerror = function(e) {
			console.log('WebSocket: Error.  Scheduling reconnect in 5 seconds...');
			RetryResetWebSocket();
		};
		
		websocket.onclose = function(e) {
			console.log('WebSocket: Closed.  Scheduling reconnect in 5 seconds...');
			RetryResetWebSocket();
		};
	}
}
function CloseWebSocket() {
	if( websocket )
		websocket.close();
	websocket = null;
}

function SetLabelsToDraw() {
	var lcLabel = GetLCLabel();
	var lcLabelNew = prompt("Enter the Lap Counters to Display (eg. A, B, AB, CD, ABC-DE):", lcLabel);
	if( lcLabelNew == null || lcLabelNew == lcLabel )
		return;
	
	lcLabel = CleanLCLabel( lcLabelNew );
	window.location.assign( '/LapCounter' + lcLabel + '.html' );
}

function onLoad() {
	lapCounter = new LapCounter( document.getElementById('lapCounter') );
	window.addEventListener('resize', lapCounter.onResize.bind(lapCounter), false);
	lapCounter.onResize();
	ResetWebSocket();
	
	document.body.addEventListener('click', SetLabelsToDraw, true );
}
</script>
	</head>
	<body onload="onLoad()">
		<canvas id="lapCounter"></canvas>
	</body>
</html>
